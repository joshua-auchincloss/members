version: "3"
env:  
  run: go run ./cli
tasks:
  dev-deps:
    cmds:
      - pip install pre-commit
      - go install github.com/go-critic/go-critic/cmd/gocritic@latest

  precommit:
    cmds:
      - task: proto
      - pre-commit run --all-files

  proto:
    cmds:
      - buf generate

  mysql:
    cmds:
      - docker run
        -d
        --name=mysql
        -p 4900:4900
        --env="MYSQL_TCP_PORT=4900"
        --env="MYSQL_ROOT_PASSWORD=mypassword"
        mysql

  postgres:
    cmds:
      - docker run
        -d --name postgres
        -e PGDATA=/var/lib/postgresql/data/pgdata
        -e POSTGRES_PASSWORD=postgres
        -p 5432:5432
        postgres

  postgres-schema:
    dotenv:
      - env/postgres.env
    
    cmds:
      - $run schema

  mysql-schema:
    dotenv:
      - env/mysql.env
    cmds:
      - $run schema

  memory-schema:
    dotenv:
      - env/sqlite.env
    cmds:
      - $run schema

  cluster:
    cmds:
      - $run start

  postgres-cluster:
    dotenv:
      - env/postgres.env
      - env/a.env
    cmds:
      - task cluster

  memory-cluster:
    dotenv:
      - env/sqlite.env
      - env/b.env
    cmds:
      - task cluster


  mysql-cluster:
    dotenv:
      - env/mysql.env
      - env/a.env
    cmds:
      - task cluster


  tidy:
    
    cmds:
      - go mod tidy

  prototest:
    dir: test
    cmds:
      - buf generate
